<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuoHives - Gmail CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        :root {
            --dh-primary: #4f46e5;
            --dh-secondary: #f0f2f5;
            --dh-text: #1f2937;
            --dh-text-secondary: #6b7280;
        }
        .dh-sidebar { scrollbar-width: thin; scrollbar-color: var(--dh-primary) var(--dh-secondary); }
        .dh-sidebar::-webkit-scrollbar { width: 5px; }
        .dh-sidebar::-webkit-scrollbar-track { background: var(--dh-secondary); }
        .dh-sidebar::-webkit-scrollbar-thumb { background-color: var(--dh-primary); border-radius: 20px; border: 3px solid var(--dh-secondary); }
        .email-list-item:hover { box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 120px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -60px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .timeline { display: flex; align-items: center; padding: 1rem 0; flex-wrap: nowrap; justify-content: space-between; overflow-x: auto; }
        .timeline-item { display: flex; flex-direction: column; align-items: center; position: relative; flex: 1 1 0%; min-width: 0; }
        .timeline-item:not(:first-child)::before { content: ''; position: absolute; width: 100%; top: 6px; left: -50%; border-top: 2px solid #e5e7eb; z-index: 0; }
        .timeline-dot { width: 14px; height: 14px; border-radius: 50%; background-color: #4f46e5; z-index: 1; border: 2px solid white; }
        .timeline-item.completed .timeline-dot { background-color: #22c55e; }
        .timeline-item.completed:not(:first-child)::before { border-color: #22c55e; }
        .timeline-date { font-size: 0.7rem; color: #6b7280; margin-top: 0.5rem; text-align: center; }
        .timeline-status { font-size: 0.75rem; font-weight: 500; text-align: center; white-space: nowrap;}
        /* Hide stage names by default; show on hover as tooltip */
        .timeline-status { visibility: hidden; position: absolute; top: -22px; background: #fff; padding: 1px 6px; border: 1px solid #e5e7eb; border-radius: 4px; color: #374151; }
        .timeline-item:hover .timeline-status { visibility: visible; }
        /* Deal meta enhancements */
        .deal-meta { display: grid; grid-template-columns: 1fr; row-gap: 6px; font-size: 12px; }
        .deal-meta .meta-label { color: #6b7280; margin-right: 6px; }
        .value-badge { display: inline-flex; align-items: center; gap: 6px; background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; padding: 4px 8px; border-radius: 9999px; font-weight: 600; }
        .company-line { display: inline-flex; align-items: center; gap: 6px; }
        .company-avatar { width: 16px; height: 16px; border-radius: 3px; }
        .link-btn { font-size: 11px; margin-left: 8px; color: #4f46e5; border: 1px solid #c7d2fe; background: #eef2ff; padding: 2px 6px; border-radius: 9999px; cursor: pointer; }
        .contacts-wrap { display: inline-flex; flex-wrap: wrap; gap: 6px; }
        .contact-chip { display: inline-flex; align-items: center; gap: 6px; border: 1px solid #e5e7eb; background: #fff; color: #111827; padding: 3px 8px; border-radius: 9999px; }
        .contact-chip .avatar { width: 16px; height: 16px; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; background: #a78bfa; color: #fff; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.35s ease-out; }
        .updates { position: relative; margin-left: 0.5rem; }
        .updates::before { content: ''; position: absolute; left: 6px; top: 0; bottom: 0; border-left: 2px dotted #e5e7eb; }
        .update-item { position: relative; padding-left: 1rem; margin-bottom: 0.5rem; }
        .update-item::before { content: ''; position: absolute; left: 0; top: 4px; width: 8px; height: 8px; border-radius: 9999px; background: #4f46e5; box-shadow: 0 0 0 2px #eef2ff; }
        /* Hide DuoHives labels in inbox until dashboard is ready */
        .hide-dh .dh-label { display: none !important; }
        .label-chip { display: inline-block; font-size: 10px; line-height: 1.1; font-weight: 600; color: #fff !important; border-radius: 6px; padding: 2px 6px; margin-left: 0.25rem; vertical-align: middle; border: 1px solid rgba(0,0,0,0.12); }
        .email-list-item .label-chip { order: -1; margin-left: 0; margin-right: 0.25rem; }
        .label-chip + .label-chip { margin-left: 0.25rem; }
        .label-dot { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 12px; flex-shrink: 0; }
        .sidebar-toggle-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 52px;
            height: 52px;
            background: #1a73e8;
            border: 1px solid #1557b0;
            border-radius: 9999px;
            box-shadow: 0 2px 12px rgba(26, 115, 232, 0.3);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s ease;
            z-index: 50;
        }
        .sidebar-toggle-button:hover {
            background: #1557b0;
            border-color: #1042a0;
            box-shadow: 0 4px 16px rgba(26, 115, 232, 0.4);
            transform: scale(1.05);
        }
        .sidebar-toggle-button x-ri-blaze-fill {
            width: 24px;
            height: 24px;
            display: block;
            color: currentColor;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-sm text-gray-900">
    <!-- Auth + Onboarding Overlays -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-white flex items-center justify-center hidden">
        <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-sm text-center border border-gray-200">
            <i class="ri-blaze-fill text-3xl text-indigo-600 mb-2"></i>
            <h2 class="text-xl font-semibold mb-5">Sign in to DuoHives</h2>
            <button id="btn-google-login" class="w-full flex items-center justify-center gap-2 border border-gray-300 rounded-lg py-2.5 hover:bg-gray-50 active:bg-gray-100">
                <i class="ri-google-fill text-red-500 text-lg"></i>
                <span class="text-sm font-medium">Continue with Google</span>
            </button>
            <p class="text-[11px] text-gray-500 mt-4">By continuing, you agree to our Terms & Privacy.</p>
        </div>
    </div>

    <div id="onboarding-screen" class="fixed inset-0 z-40 bg-white flex items-center justify-center hidden">
        <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-xl border border-gray-200">
            <div class="flex items-center mb-4">
                <i class="ri-blaze-fill text-2xl text-indigo-600 mr-2"></i>
                <h2 class="text-lg font-semibold">Getting your inbox ready</h2>
            </div>
            <div class="mb-4">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div id="ob-progress-bar" class="h-full bg-indigo-500 transition-all" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span id="ob-progress-label">0%</span>
                    <span>~10s</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Fetched</div>
                    <div id="ob-fetched" class="font-semibold">0/200</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Classified</div>
                    <div id="ob-classified" class="font-semibold">0</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Sales-related</div>
                    <div id="ob-sales" class="font-semibold">0</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Extracted & Enriched</div>
                    <div id="ob-enriched" class="font-semibold">0</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Opportunities</div>
                    <div id="ob-opps" class="font-semibold">0</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Contacts</div>
                    <div id="ob-contacts" class="font-semibold">0</div>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="text-gray-500 text-xs">Companies</div>
                    <div id="ob-companies" class="font-semibold">0</div>
                </div>
            </div>
            <div id="ob-success" class="hidden mt-5 p-3 bg-green-50 border border-green-200 rounded-lg text-sm text-green-700 flex items-center justify-between">
                <div class="flex items-center"><i class="ri-check-line mr-2"></i>Ready! Your DuoHives pipeline is set.</div>
                <button id="btn-go-dashboard" class="px-3 py-1.5 bg-indigo-600 text-white rounded-md text-xs hover:bg-indigo-500">Go to Dashboard</button>
            </div>
        </div>
    </div>

    <div id="app-shell" class="flex h-screen w-full">
        <!-- Gmail Left Sidebar -->
    <aside class="w-[300px] bg-[#f0f2f5] flex-shrink-0 flex flex-col">
            <!-- ... existing Gmail sidebar code ... -->
            <div class="p-4">
                <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/logo_gmail_lockup_default_1x_r5.png" alt="Gmail" class="h-8">
            </div>
            <div class="px-2">
                <button class="bg-[#c2e7ff] hover:bg-[#a2d7ff] text-black font-semibold py-4 px-6 rounded-2xl w-full flex items-center justify-center shadow-sm">
                    <i class="ri-pencil-line mr-2 text-xl"></i> Compose
                </button>
            </div>
            <nav class="mt-4 flex-1 overflow-y-auto">
                <ul>
                    <li class="px-4 py-2 bg-[#d3e3fd] rounded-r-full font-bold text-black"><a href="#" class="flex items-center"><i class="ri-inbox-fill mr-4"></i> Inbox <span class="ml-auto text-xs">12</span></a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><i class="ri-star-line mr-4"></i> Starred</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><i class="ri-time-line mr-4"></i> Snoozed</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><i class="ri-send-plane-fill mr-4"></i> Sent</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><i class="ri-draft-line mr-4"></i> Drafts</a></li>
                </ul>
                <div class="px-4 mt-6 mb-2 text-xs font-bold text-gray-600">Labels</div>
                <ul>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-blue-500"></span> Project Alpha</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-green-500"></span> Marketing</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-indigo-600"></span> DuoHives/DH-101</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-indigo-600"></span> DuoHives/DH-102</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-indigo-600"></span> DuoHives/DH-103</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-indigo-600"></span> DuoHives/DH-NEW</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-rose-600"></span> Sales</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-slate-600"></span> Newsletters</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-emerald-600"></span> Finance</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-sky-600"></span> Social</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-indigo-600"></span> Calendar</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-pink-600"></span> Internal</a></li>
                    <li class="px-4 py-2 hover:bg-gray-200 rounded-r-full"><a href="#" class="flex items-center"><span class="label-dot bg-slate-600"></span> Notifications</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-white">
            <!-- ... existing header code ... -->
            <header class="p-2 border-b flex items-center">
                <div class="relative w-full max-w-2xl mx-auto">
                    <i class="ri-search-line absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" placeholder="Search mail" class="w-full bg-gray-100 rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex items-center ml-auto">
                    <button class="p-2 rounded-full hover:bg-gray-200"><i class="ri-question-line text-xl"></i></button>
                    <button class="p-2 rounded-full hover:bg-gray-200"><i class="ri-settings-3-line text-xl"></i></button>
                    <button class="p-2 rounded-full hover:bg-gray-200"><i class="ri-apps-2-line text-xl"></i></button>
                    <img src="https://placehold.co/32x32/E2E8F0/4A5568?text=U" alt="User" class="rounded-full ml-2">
                </div>
            </header>
            
            <div id="inbox-view" class="flex-1 overflow-y-auto">
                <!-- Constrained width wrapper to match thread view width -->
                <div class="max-w-[816px] mx-auto w-full">
                    <!-- Inbox Actions -->
                    <div class="p-2 border-b flex items-center">
                        <input type="checkbox" class="mr-4 ml-2">
                        <button class="p-2 rounded-full hover:bg-gray-200"><i class="ri-refresh-line"></i></button>
                        <button class="p-2 rounded-full hover:bg-gray-200"><i class="ri-more-2-fill"></i></button>
                    </div>
                    <!-- Email List -->
                    <ul>
                      <!-- Gmail-like rows with labels; DuoHives labels appear as normal chips -->
                      <li id="email-1" class="email-list-item flex items-center p-3 border-b cursor-pointer bg-blue-50" onclick="selectEmail('email-1','deal-1')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">Innovate Inc.</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-101</span>
                          <span class="ml-2 font-semibold text-gray-900">Partnership Proposal</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Details about our new synergy plan...</span>
                        </div>
                        <div class="w-24 text-right text-xs font-bold">10:42 AM</div>
                      </li>
                      <li id="email-2" class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-2','deal-2')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="font-bold w-56 truncate">Alex from QuantumLeap</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-102</span>
                          <span class="ml-2 font-semibold text-gray-900">Follow up on pricing</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Just checking in on the quote...</span>
                          <span class="label-chip bg-blue-600">Negotiation</span>
                        </div>
                        <div class="w-24 text-right text-xs font-bold">9:15 AM</div>
                      </li>
                      <li id="email-3" class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-3','deal-3')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Fusion Dynamics</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-103</span>
                          <span class="ml-2 font-semibold text-gray-900">Project Phoenix Kick-off</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Let's schedule a time to discuss...</span>
                          <span class="label-chip bg-amber-600">Prospect</span>
                        </div>
                        <div class="w-24 text-right text-xs">Yesterday</div>
                      </li>
                      <li id="email-4" class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-4',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">TechCrunch</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-slate-600">Newsletters</span>
                          <span class="ml-2 font-semibold text-gray-900">Weekly Newsletter</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">The latest news in tech and startups...</span>
                        </div>
                        <div class="w-24 text-right text-xs">Yesterday</div>
                      </li>
                      <li id="email-5" class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-5','deal-4')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">Maria Garcia</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-NEW</span>
                          <span class="ml-2 font-semibold text-gray-900">Inquiry about your services</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Found you via a referral and wanted to learn more...</span>
                          <span class="label-chip bg-purple-600">Lead</span>
                        </div>
                        <div class="w-24 text-right text-xs">Sep 16</div>
                      </li>
                      <!-- Extra rows to feel messy -->
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-6',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">Billing Team</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-emerald-600">Finance</span>
                          <span class="ml-2 font-semibold text-gray-900">Invoice 34219 due</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Reminder: payment due on Friday...</span>
                        </div>
                        <div class="w-24 text-right text-xs">9:01 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-7',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">GitHub</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-slate-600">Notifications</span>
                          <span class="ml-2 font-semibold text-gray-900">[duohives] New comment on issue #128</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Please review the latest patch...</span>
                        </div>
                        <div class="w-24 text-right text-xs">8:47 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-8',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">Ava Nguyen</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-pink-600">Internal</span>
                          <span class="ml-2 font-semibold text-gray-900">Re: Agenda for tomorrow</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Sounds good, I added a few notes...</span>
                        </div>
                        <div class="w-24 text-right text-xs">8:02 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-9',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Google Calendar</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600">Calendar</span>
                          <span class="ml-2 font-semibold text-gray-900">Invitation: Product sync</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Tue, 10:00–10:30 AM</span>
                        </div>
                        <div class="w-24 text-right text-xs">7:55 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-10',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">Twitter</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-sky-600">Social</span>
                          <span class="ml-2 font-semibold text-gray-900">New follower: @pipeline_wizard</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">You have a new follower...</span>
                        </div>
                        <div class="w-24 text-right text-xs">7:20 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-11',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">HR Team</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-slate-600">Company</span>
                          <span class="ml-2 font-semibold text-gray-900">Policy update</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Please acknowledge the updated PTO policy...</span>
                        </div>
                        <div class="w-24 text-right text-xs">7:00 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-12',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Stripe</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-emerald-600">Finance</span>
                          <span class="ml-2 font-semibold text-gray-900">Payout received</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Your transfer of $4,250 has completed.</span>
                        </div>
                        <div class="w-24 text-right text-xs">6:42 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-13',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Support</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-rose-600">Urgent</span>
                          <span class="ml-2 font-semibold text-gray-900">Re: Ticket #39811</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Can you provide a HAR file...</span>
                        </div>
                        <div class="w-24 text-right text-xs">6:10 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-14',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">Amazon</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-amber-600">Purchases</span>
                          <span class="ml-2 font-semibold text-gray-900">Your order has shipped</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Arriving Thursday by 9pm...</span>
                        </div>
                        <div class="w-24 text-right text-xs">5:25 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-15',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">Marketing</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-pink-600">Internal</span>
                          <span class="ml-2 font-semibold text-gray-900">Q4 campaign kickoff</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Deck + timeline attached...</span>
                        </div>
                        <div class="w-24 text-right text-xs">5:02 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-16',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">LinkedIn</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-sky-600">Updates</span>
                          <span class="ml-2 font-semibold text-gray-900">15 new job alerts</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">We found new roles that match...</span>
                        </div>
                        <div class="w-24 text-right text-xs">4:58 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-17',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Notion</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-violet-600">Docs</span>
                          <span class="ml-2 font-semibold text-gray-900">Doc shared: CRM requirements</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">ACME shared a doc with you...</span>
                        </div>
                        <div class="w-24 text-right text-xs">4:30 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-18',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Salesforce</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-slate-600">Digest</span>
                          <span class="ml-2 font-semibold text-gray-900">Weekly digest</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Open opportunities and pipeline health...</span>
                        </div>
                        <div class="w-24 text-right text-xs">4:00 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-19',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">Travel</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-sky-600">Travel</span>
                          <span class="ml-2 font-semibold text-gray-900">Your itinerary to NYC</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Flight UA 941 · Seat 12A...</span>
                        </div>
                        <div class="w-24 text-right text-xs">3:48 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-20',null)">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Medium</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-teal-600">Reading</span>
                          <span class="ml-2 font-semibold text-gray-900">Top stories for you</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">How to build invisible CRMs...</span>
                        </div>
                        <div class="w-24 text-right text-xs">3:20 AM</div>
                      </li>
                      <!-- Additional sales-heavy emails -->
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-26','deal-1')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">Emma — ACME</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-101</span>
                          <span class="ml-2 font-semibold text-gray-900">Proposal review + next steps</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">We aligned internally, can you revise section 3?</span>
                          <span class="label-chip bg-green-600">Proposal</span>
                        </div>
                        <div class="w-24 text-right text-xs">2:55 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-27','deal-2')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">Chris @ Globex</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-102</span>
                          <span class="ml-2 font-semibold text-gray-900">Pricing revision v2</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Attached: revised tiering for 250 seats</span>
                          <span class="label-chip bg-blue-600">Negotiation</span>
                        </div>
                        <div class="w-24 text-right text-xs">2:40 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-28','deal-3')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Olivia (Sales)</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-103</span>
                          <span class="ml-2 font-semibold text-gray-900">Discovery recap + action items</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Recap of Phoenix discovery and next meeting...</span>
                          <span class="label-chip bg-amber-600">Prospect</span>
                        </div>
                        <div class="w-24 text-right text-xs">2:10 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-29','deal-4')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="font-bold w-56 truncate">New Lead — Referral</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-NEW</span>
                          <span class="ml-2 font-semibold text-gray-900">Interested in demo</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Saw your case study from ACME...</span>
                          <span class="label-chip bg-purple-600">Lead</span>
                        </div>
                        <div class="w-24 text-right text-xs">1:58 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-30','deal-1')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Legal — Innovate Inc.</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-101</span>
                          <span class="ml-2 font-semibold text-gray-900">Contract redline v3</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">See comments 12 and 14 on indemnity...</span>
                          <span class="label-chip bg-blue-600">Negotiation</span>
                        </div>
                        <div class="w-24 text-right text-xs">1:45 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-31','deal-2')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Procurement — QuantumLeap</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-102</span>
                          <span class="ml-2 font-semibold text-gray-900">PO attached</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Please countersign and return...</span>
                          <span class="label-chip bg-green-600">Proposal</span>
                        </div>
                        <div class="w-24 text-right text-xs">1:20 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-32','deal-3')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-fill mr-3 text-yellow-400"></i>
                        <span class="w-56 truncate">CFO — Fusion Dynamics</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-103</span>
                          <span class="ml-2 font-semibold text-gray-900">Budget confirmation</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Approved for Q4 — proceed to proposal</span>
                          <span class="label-chip bg-amber-600">Prospect</span>
                        </div>
                        <div class="w-24 text-right text-xs">12:58 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-33','deal-4')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Maria Garcia</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-NEW</span>
                          <span class="ml-2 font-semibold text-gray-900">Re: Scheduling intro call</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Tomorrow 11am PT works for me...</span>
                          <span class="label-chip bg-purple-600">Lead</span>
                        </div>
                        <div class="w-24 text-right text-xs">12:40 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-34','deal-1')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">Innovate Inc.</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-indigo-600 dh-label">DuoHives/DH-101</span>
                          <span class="ml-2 font-semibold text-gray-900">SOW draft</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Draft statement of work attached</span>
                          <span class="label-chip bg-blue-600">Negotiation</span>
                        </div>
                        <div class="w-24 text-right text-xs">12:15 AM</div>
                      </li>
                      <li class="email-list-item flex items-center p-3 border-b cursor-pointer" onclick="selectEmail('email-35','deal-2')">
                        <input type="checkbox" class="mr-3" onclick="event.stopPropagation()">
                        <i class="ri-star-line mr-3 text-gray-400"></i>
                        <span class="w-56 truncate">QuantumLeap</span>
                        <div class="flex-1 flex items-center truncate">
                          <span class="label-chip bg-rose-600">Sales</span>
                          <span class="ml-2 font-semibold text-gray-900">Legal review kickoff</span>
                          <span class="mx-2 text-gray-400">-</span>
                          <span class="text-gray-500 truncate">Looping in counsel for redlines</span>
                        </div>
                        <div class="w-24 text-right text-xs">12:02 AM</div>
                      </li>
                    </ul>
                </div>
            </div>

            <div id="thread-view" class="hidden flex-1 flex flex-col overflow-y-auto" hidden>
                <!-- Constrained width wrapper to match inbox list width -->
                <div class="max-w-[816px] mx-auto w-full p-6" id="thread-view-inner">
                    <!-- Email thread view will be populated by JS when an email is selected -->
                </div>
            </div>

        </main>
        
        <!-- DuoHives Sidebar -->
    <aside id="duohives-sidebar" class="w-[360px] bg-[#f6f8fc] border-l flex-shrink-0 flex flex-col dh-sidebar overflow-y-auto">
            <header class="p-4 border-b flex items-center sticky top-0 bg-[#1a73e8] z-10">
                <i class="ri-blaze-fill text-2xl text-white mr-2"></i>
                <h1 class="text-lg font-bold text-white">DuoHives</h1>
                <div class="ml-auto flex items-center">
                    <div class="tooltip">
                        <button id="btn-dh-home" class="p-2 rounded-full hover:bg-white/10 text-white" title="Home"><i class="ri-home-3-line"></i></button>
                        <span class="tooltiptext">Home</span>
                    </div>
                    <div class="tooltip">
                        <button class="p-2 rounded-full hover:bg-white/10 text-white"><i class="ri-notification-3-line"></i></button>
                        <span class="tooltiptext">Notifications</span>
                    </div>
                    <div class="tooltip">
                        <button class="p-2 rounded-full hover:bg-white/10 text-white"><i class="ri-settings-3-line"></i></button>
                         <span class="tooltiptext">Settings</span>
                    </div>
                </div>
            </header>

            <!-- Inbox/Label View -->
            <!-- DuoHives Login (Sidebar) -->
            <div id="dh-login-view" class="p-4 hidden flex-1 flex items-center justify-center" hidden>
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm w-full max-w-sm">
                    <h3 class="font-bold text-lg mb-2">Sign in</h3>
                    <p class="text-xs text-gray-500 mb-4">Connect Google to start your DuoHives pipeline.</p>
                    <button id="dh-btn-google-login" class="w-full flex items-center justify-center gap-2 border border-gray-300 rounded-lg py-2.5 hover:bg-gray-50">
                        <i class="ri-google-fill text-red-500"></i>
                        <span class="text-sm font-medium">Continue with Google</span>
                    </button>
                </div>
            </div>

            <!-- DuoHives Onboarding (Sidebar) -->
            <div id="dh-onboarding-view" class="p-4 hidden flex-1 flex items-center justify-center" hidden>
                <div class="bg-white rounded-xl border border-gray-200 p-6 shadow-sm w-full max-w-sm">
                    <h3 class="font-bold text-lg mb-3">Setting up CRM from Emails</h3>
                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden mb-3">
                        <div id="dh-ob-bar" class="h-full bg-indigo-500 transition-all" style="width:0%"></div>
                    </div>
                    <div class="text-[12px] text-gray-500 mb-4">
                        <span id="dh-ob-label">0%</span> • about 10s
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="text-[11px] text-gray-500 uppercase mb-2">Emails</div>
                            <div class="space-y-2">
                                <div>
                                    <div class="text-xs text-gray-500">Fetched</div>
                                    <div id="dh-ob-fetched" class="text-base font-semibold">0/200</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Classified</div>
                                    <div id="dh-ob-classified" class="text-base font-semibold">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">CRM</div>
                                    <div id="dh-ob-sales" class="text-base font-semibold">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Extracted & Enriched</div>
                                    <div id="dh-ob-enriched" class="text-base font-semibold">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                            <div class="text-[11px] text-gray-500 uppercase mb-2">Pipeline</div>
                            <div class="space-y-2">
                                <div>
                                    <div class="text-xs text-gray-500">Opportunities</div>
                                    <div id="dh-ob-opps" class="text-base font-semibold">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Contacts</div>
                                    <div id="dh-ob-contacts" class="text-base font-semibold">0</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Companies</div>
                                    <div id="dh-ob-companies" class="text-base font-semibold">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dh-ob-success" class="hidden mt-3 p-2 bg-green-50 border border-green-200 rounded text-green-700 text-xs flex items-center justify-between">
                        <span class="flex items-center"><i class="ri-check-line mr-1"></i>Done! DuoHives is ready.</span>
                        <button id="dh-btn-go-dashboard" class="px-2 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-500">Open</button>
                    </div>
                </div>
            </div>

            <div id="dh-inbox-view" class="flex-1 flex flex-col overflow-y-auto">
                <!-- ... existing inbox view code ... -->
                <div class="p-4 border-b border-gray-200 space-y-5">
                    <section>
                        <h2 class="font-bold text-base mb-3">Pipeline Snapshot</h2>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div id="ps-deals" class="bg-gray-50 border border-gray-200 rounded-xl py-3 cursor-pointer hover:border-indigo-200">
                                <p class="text-2xl font-semibold text-gray-900">18</p>
                                <p class="text-[11px] text-gray-500 uppercase tracking-wide">Deals</p>
                            </div>
                            <div id="ps-inpipeline" class="bg-gray-50 border border-gray-200 rounded-xl py-3 cursor-pointer hover:border-indigo-200">
                                <p class="text-2xl font-semibold text-gray-900">$62K</p>
                                <p class="text-[11px] text-gray-500 uppercase tracking-wide">In Pipeline</p>
                            </div>
                            <div id="ps-closed" class="bg-gray-50 border border-gray-200 rounded-xl py-3 cursor-pointer hover:border-indigo-200">
                                <p class="text-2xl font-semibold text-gray-900">$48K</p>
                                <p class="text-[11px] text-gray-500 uppercase tracking-wide">Last Month</p>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold text-base mb-2">Current Deals</h3>
                        <ul class="border border-gray-200 rounded-xl overflow-hidden bg-white text-sm divide-y divide-gray-100">
                            <li class="px-3 py-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate">Innovate Inc. Partnership</p>
                                    <span class="label-chip bg-green-600">Proposal</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                    <span>Innovate Inc.</span>
                                    <span>•</span>
                                    <span>2 days ago</span>
                                    <span>•</span>
                                    <span>$25K</span>
                                </div>
                            </li>
                            <li class="px-3 py-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate">QuantumLeap Pricing</p>
                                    <span class="label-chip bg-blue-600">Negotiation</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                    <span>QuantumLeap</span>
                                    <span>•</span>
                                    <span>1 day ago</span>
                                    <span>•</span>
                                    <span>$10K</span>
                                </div>
                            </li>
                            <li class="px-3 py-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate">Synergy Corp Demo</p>
                                    <span class="label-chip bg-emerald-600">Qualified</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                    <span>Synergy Corp</span>
                                    <span>•</span>
                                    <span>3 days ago</span>
                                    <span>•</span>
                                    <span>$12K</span>
                                </div>
                            </li>
                            <li class="px-3 py-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate">Project Phoenix</p>
                                    <span class="label-chip bg-amber-600">Prospect</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                    <span>Fusion Dynamics</span>
                                    <span>•</span>
                                    <span>5 days ago</span>
                                    <span>•</span>
                                    <span>TBD</span>
                                </div>
                            </li>
                            <li class="px-3 py-3">
                                <div class="flex items-center justify-between">
                                    <p class="font-medium text-gray-900 truncate">New Inquiry from Referral</p>
                                    <span class="label-chip bg-purple-600">Lead</span>
                                </div>
                                <div class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                                    <span>Unknown</span>
                                    <span>•</span>
                                    <span>2 days ago</span>
                                    <span>•</span>
                                    <span>TBD</span>
                                </div>
                            </li>
                        </ul>
                        <div class="mt-2 flex justify-center">
                            <button id="btn-view-pipeline" class="text-xs font-semibold text-indigo-600 px-3 py-1 border border-indigo-200 rounded-full hover:bg-indigo-50" type="button">View all deals in pipeline</button>
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold text-base mb-3">Navigate</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm font-semibold">
                            <a href="#" class="flex items-center justify-center border border-gray-200 rounded-lg py-2 text-indigo-600 hover:bg-indigo-50">
                                <i class="ri-building-4-line mr-2"></i>Companies
                            </a>
                            <a href="#" class="flex items-center justify-center border border-gray-200 rounded-lg py-2 text-indigo-600 hover:bg-indigo-50">
                                <i class="ri-user-3-line mr-2"></i>Contacts
                            </a>
                        </div>
                    </section>
                </div>

                <div class="mt-auto p-3 bg-gray-50 border-t border-gray-200">
                    <section>
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-1">Email Processing</h3>
                        <p class="text-sm text-gray-700">
                            <span class="font-semibold text-gray-900">42k</span> Total •
                            <span class="font-semibold text-gray-900">32k</span> Processed •
                            <span class="font-semibold text-indigo-600">12.5k</span> CRM
                        </p>
                        <div class="flex h-2 rounded-full overflow-hidden bg-gray-200 mt-2">
                            <div class="bg-indigo-500" style="width:30%"></div>
                            <div class="bg-indigo-300" style="width:46%"></div>
                            <div class="bg-gray-300" style="width:24%"></div>
                        </div>
                        <div class="flex justify-between mt-1 text-[11px] text-gray-500">
                            <span><span class="inline-block w-2.5 h-2.5 rounded-sm bg-indigo-500 mr-1"></span>CRM</span>
                            <span><span class="inline-block w-2.5 h-2.5 rounded-sm bg-indigo-300 mr-1"></span>Processed</span>
                            <span><span class="inline-block w-2.5 h-2.5 rounded-sm bg-gray-300 mr-1"></span>Remaining</span>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Email/Thread View (Deal View) -->
            <div id="dh-deal-view" class="hidden p-4" hidden>
                 <!-- Populated by JS -->
            </div>

            <!-- Pipeline View (Sidebar) -->
            <div id="dh-pipeline-view" class="hidden p-4" hidden>
                <div class="flex items-center mb-3">
                    <button id="btn-pipeline-back" class="px-2 py-1 text-xs border border-gray-200 rounded hover:bg-gray-100 mr-2"><i class="ri-arrow-left-line mr-1"></i> Back</button>
                    <h3 class="font-bold text-base">Pipeline</h3>
                </div>
                <div id="dh-pipeline-container" class="space-y-3"></div>
            </div>
        </aside>
    </div>

    <script>
        if (!customElements.get('x-ri-blaze-fill')) {
            customElements.define('x-ri-blaze-fill', class extends HTMLElement {
                connectedCallback() {
                    if (!this.initialized) {
                        this.style.display = 'inline-flex';
                        this.style.alignItems = 'center';
                        this.style.justifyContent = 'center';
                        this.style.width = '24px';
                        this.style.height = '24px';
                        const icon = document.createElement('i');
                        icon.className = 'ri-blaze-fill';
                        icon.style.fontSize = '24px';
                        icon.style.lineHeight = '1';
                        icon.style.color = 'inherit';
                        icon.setAttribute('aria-hidden', this.getAttribute('aria-hidden') ?? 'true');
                        this.appendChild(icon);
                        this.initialized = true;
                    }
                }
            });
        }

        const inboxView = document.getElementById('inbox-view');
        const threadView = document.getElementById('thread-view');
        const threadViewInner = document.getElementById('thread-view-inner');
        const dhInboxView = document.getElementById('dh-inbox-view');
        const dhDealView = document.getElementById('dh-deal-view');
        const duohivesSidebar = document.getElementById('duohives-sidebar');
        const SIDEBAR_WIDTH = 360;
        const SIDEBAR_CLOSE_ICON = `<x-ri-blaze-fill aria-hidden="true"></x-ri-blaze-fill>`;
        const SIDEBAR_OPEN_ICON = `<x-ri-blaze-fill aria-hidden="true"></x-ri-blaze-fill>`;
        let sidebarToggleButton = null;
        let sidebarVisible = loadSidebarVisibility();
        
        const dealData = {
            'deal-1': { 
                subject: 'Partnership Proposal', from: 'Sarah Chen', fromEmail: 'sarah@innovate.com', fromAvatar: 'S', dealName: 'Innovate Inc. Partnership', status: 'Proposal Sent', statusColor: 'green', value: '$25,000 (est.)', company: 'Innovate Inc.', companyAvatar: 'I', contacts: [{name: 'Sarah Chen', avatar: 'S'}, {name: 'John Doe', avatar: 'J'}],
                summary: 'Innovate Inc. seeks a strategic partnership to expand market reach. Proposal submitted and awaiting feedback. Initial signals look positive. We aligned on scope, value, and success criteria during discovery. Next step: consolidate Q&A from stakeholders and confirm timeline for decision by Sep 25. Risks: budget approvals and competing priorities.',
                notes: [
                    { ts: Date.now()-86400000*2, text: 'Shared proposal deck and pricing tiers.'},
                    { ts: Date.now()-86400000, text: 'Follow-up sent with clarifications on scope.'}
                ],
                fitScore: 85,
                conversionRate: 70,
                timeline: [
                    { status: 'Contact', date: 'Sep 12', completed: true },
                    { status: 'Proposal', date: 'Sep 15', completed: true },
                    { status: 'Follow-up', date: 'Sep 18', completed: false },
                    { status: 'Decision', date: 'Sep 25', completed: false },
                ],
                emailContent: `<p>Hi team,</p><p>Following up on our call, I've attached the detailed proposal for our potential partnership...</p>`
            },
            'deal-2': { 
                subject: 'Follow up on pricing', from: 'Alex from QuantumLeap', fromEmail: 'alex@quantumleap.co', fromAvatar: 'A', dealName: 'QuantumLeap Pricing', status: 'Negotiation', statusColor: 'blue', value: '$10,000', company: 'QuantumLeap', companyAvatar: 'Q', contacts: [{name: 'Alex Rivera', avatar: 'A'}],
                summary: 'QuantumLeap is negotiating a 12-month software license. Discussing pricing tiers and volume discounts. Procurement requested a breakdown for annual vs. monthly options and a revised SoW. Next step: send redlines and book decision call for next week. Expectation: close by end of month if legal review is smooth.',
                notes: [ { ts: Date.now()-86400000*3, text: 'Shared revised pricing with volume discount.' } ],
                fitScore: 70,
                conversionRate: 60,
                timeline: [
                    { status: 'Contact', date: 'Sep 10', completed: true },
                    { status: 'Demo', date: 'Sep 14', completed: true },
                    { status: 'Negotiation', date: 'Sep 17', completed: true },
                    { status: 'Closing', date: 'Sep 22', completed: false },
                ],
                emailContent: `<p>Hi,</p><p>Just wanted to check in on the quote we sent over last week. Are there any questions I can answer?</p>`
            },
            'deal-3': { 
                subject: 'Re: Project Phoenix Kick-off', from: 'Fusion Dynamics', fromEmail: 'contact@fusiondynamics.com', fromAvatar: 'F', dealName: 'Project Phoenix', status: 'Initial Contact', statusColor: 'yellow', value: 'N/A', company: 'Fusion Dynamics', companyAvatar: 'F', contacts: [{name: 'Mark Johnson', avatar: 'M'}],
                summary: 'Initial discovery call complete. Team is aligning on scope for Project Phoenix. We agreed to compile the problem statement and shortlist of must-haves. Next step: schedule demo and validate feasibility for MVP. Internal note: involve Solutions Architect for integration questions.',
                notes: [],
                fitScore: 60,
                conversionRate: 45,
                timeline: [
                     { status: 'Contact', date: 'Sep 17', completed: true },
                     { status: 'Discovery', date: 'Sep 20', completed: false },
                     { status: 'Demo', date: 'Sep 28', completed: false },
                ],
                emailContent: `<p>Let's schedule a time to discuss the initial phase of Project Phoenix. How does your calendar look next week?</p>`
            },
             'deal-4': { 
                subject: 'Inquiry about your services', from: 'Maria Garcia', fromEmail: 'maria.g@example.com', fromAvatar: 'M', dealName: 'New Inquiry from Referral', status: 'New Lead', statusColor: 'purple', value: 'TBD', company: 'Unknown', companyAvatar: '?', contacts: [{name: 'Maria Garcia', avatar: 'M'}],
                summary: 'A new inbound lead from a referral. They are interested in learning more about our services. Immediate follow-up needed. Next step: quick intro call to qualify needs and timeline. If fit confirmed, propose a short POC to demonstrate value.',
                notes: [ ],
                fitScore: 75,
                conversionRate: 50,
                timeline: [
                    { status: 'New Lead', date: 'Sep 16', completed: true },
                    { status: 'Response', date: 'Sep 18', completed: false },
                ],
                emailContent: `<p>Hi there,</p><p>I found you through a referral and was hoping to learn more about your services. When would be a good time to connect?</p>`
            }
        };

        function loadSidebarVisibility() {
            try {
                const stored = localStorage.getItem('duohives-sidebar-visible');
                return stored !== null ? JSON.parse(stored) : true;
            } catch (error) {
                console.warn('Failed to load sidebar state', error);
                return true;
            }
        }

        function saveSidebarVisibility() {
            try {
                localStorage.setItem('duohives-sidebar-visible', JSON.stringify(sidebarVisible));
            } catch (error) {
                console.warn('Failed to save sidebar state', error);
            }
        }

        function applySidebarVisibility() {
            if (!duohivesSidebar) return;
            duohivesSidebar.classList.toggle('hidden', !sidebarVisible);
            duohivesSidebar.hidden = !sidebarVisible;
            duohivesSidebar.setAttribute('aria-hidden', (!sidebarVisible).toString());
            updateToggleButtonState();
        }

        function updateToggleButtonState() {
            if (!sidebarToggleButton) return;
            sidebarToggleButton.setAttribute('aria-expanded', sidebarVisible.toString());
            const computedSidebarWidth = duohivesSidebar && !duohivesSidebar.classList.contains('hidden')
                ? duohivesSidebar.offsetWidth || SIDEBAR_WIDTH
                : SIDEBAR_WIDTH;
            sidebarToggleButton.style.right = sidebarVisible ? `${computedSidebarWidth + 24}px` : '24px';
            sidebarToggleButton.innerHTML = sidebarVisible ? SIDEBAR_CLOSE_ICON : SIDEBAR_OPEN_ICON;
            sidebarToggleButton.title = sidebarVisible ? 'Hide DuoHives sidebar' : 'Show DuoHives sidebar';
            sidebarToggleButton.setAttribute('aria-label', sidebarVisible ? 'Hide DuoHives sidebar' : 'Show DuoHives sidebar');
        }

        function initSidebarToggle() {
            if (sidebarToggleButton || !duohivesSidebar) return;
            sidebarToggleButton = document.createElement('button');
            sidebarToggleButton.className = 'sidebar-toggle-button';
            sidebarToggleButton.type = 'button';
            sidebarToggleButton.setAttribute('aria-controls', 'duohives-sidebar');
            sidebarToggleButton.setAttribute('aria-label', 'Toggle DuoHives sidebar');
            sidebarToggleButton.addEventListener('click', () => {
                sidebarVisible = !sidebarVisible;
                saveSidebarVisibility();
                applySidebarVisibility();
            });
            sidebarToggleButton.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    sidebarToggleButton.click();
                }
            });
            document.body.appendChild(sidebarToggleButton);
            applySidebarVisibility();
        }

        function selectEmail(emailId, dealId) {
            // Deselect all other emails
            document.querySelectorAll('.email-list-item').forEach(item => {
                item.classList.remove('bg-blue-50');
            });
            // Select clicked email if it exists
            const selectedEmailEl = document.getElementById(emailId);
            if(selectedEmailEl) {
                selectedEmailEl.classList.add('bg-blue-50');
            }
            
            // Switch main view
            inboxView.classList.add('hidden');
            threadView.classList.remove('hidden');
            // Also toggle native hidden attribute for robustness
            if (inboxView) inboxView.hidden = true;
            if (threadView) threadView.hidden = false;

            const data = dealData[dealId];
            
            if (data) {
                threadViewInner.innerHTML = `
                <h2 class="text-2xl font-normal mb-4 px-0" id="thread-subject">${data.subject}</h2>
                <div class="flex items-center mb-6">
                    <img src="https://placehold.co/40x40/7C3AED/FFFFFF?text=${data.fromAvatar}" class="rounded-full mr-3">
                    <div>
                        <span class="font-bold">${data.from}</span> <span class="text-gray-500 text-xs">&lt;${data.fromEmail}&gt;</span>
                        <div class="text-gray-500 text-xs">to me</div>
                    </div>
                    <div class="ml-auto text-gray-500 text-xs">Today</div>
                </div>
                <div class="prose max-w-none">${data.emailContent}</div>
                <div class="mt-8 border-t pt-4">
                     <button class="py-2 px-4 border rounded-md hover:bg-gray-100"><i class="ri-reply-line mr-2"></i> Reply</button>
                     <button class="py-2 px-4 border rounded-md hover:bg-gray-100 ml-2"><i class="ri-share-forward-line mr-2"></i> Forward</button>
                </div>`;
                showDealView(dealId);
            } else {
                 threadViewInner.innerHTML = `<h2 class="text-2xl font-normal mb-4">TechCrunch</h2> <p>This is a regular email not associated with a deal.</p>`;
                 showInboxView(true); // pass true to indicate we are just hiding the deal view
            }
        }

        function showInboxView(hideOnly = false) {
            dhDealView.classList.add('hidden');
            dhInboxView.classList.remove('hidden');
            if (dhDealView) dhDealView.hidden = true;
            if (dhInboxView) dhInboxView.hidden = false;

            if (hideOnly) return;

            // Also reset main view to inbox
            threadView.classList.add('hidden');
            inboxView.classList.remove('hidden');
            if (threadView) threadView.hidden = true;
            if (inboxView) inboxView.hidden = false;

            // Clear any previous thread content (optional)
            if (threadViewInner) {
                threadViewInner.innerHTML = '';
            }

            // Deselect all emails
             document.querySelectorAll('.email-list-item').forEach(item => {
                item.classList.remove('bg-blue-50');
            });
        }
        
        function canonicalizeStatus(status) {
            const s = (status || '').toLowerCase();
            if (s.includes('lead')) return 'Lead';
            if (s.includes('initial') || s.includes('contact') || s.includes('prospect') || s.includes('discovery')) return 'Prospect';
            if (s.includes('demo') || s.includes('qualified') || s.includes('evaluation')) return 'Qualified';
            if (s.includes('proposal')) return 'Proposal';
            if (s.includes('negotiation') || s.includes('pricing') || s.includes('decision') || s.includes('closing')) return 'Negotiation';
            if (s.includes('closed') || s.includes('won') || s.includes('lost')) return 'Closed';
            return 'Prospect';
        }

        function statusClass(stage) {
            switch (stage) {
                case 'Lead': return 'bg-purple-600';
                case 'Prospect': return 'bg-amber-600';
                case 'Qualified': return 'bg-emerald-600';
                case 'Proposal': return 'bg-green-600';
                case 'Negotiation': return 'bg-blue-600';
                case 'Closed': return 'bg-slate-600';
                default: return 'bg-gray-600';
            }
        }

        function updateDhInboxLabels() {
            const map = {
                'DuoHives/DH-101': 'deal-1',
                'DuoHives/DH-102': 'deal-2',
                'DuoHives/DH-103': 'deal-3',
                'DuoHives/DH-NEW': 'deal-4'
            };
            document.querySelectorAll('.dh-label').forEach((chip) => {
                const key = (chip.textContent || '').trim();
                const id = map[key];
                const d = id && dealData[id];
                if (d) {
                    const st = canonicalizeStatus(d.status);
                    chip.innerHTML = `<i class="ri-blaze-fill mr-1 align-middle"></i> ${d.dealName} - ${st}`;
                }
            });
        }

        // Render the right-hand DuoHives deal view
        function showDealView(dealId) {
        const data = dealData[dealId] || {};
        const stageOrder = ['Lead','Prospect','Qualified','Proposal','Negotiation','Closed'];
        const currentStage = canonicalizeStatus(data.status);
        const currentIdx = stageOrder.indexOf(currentStage);
        const dateByStage = {};
        (data.timeline || []).forEach(m => { dateByStage[canonicalizeStatus(m.status)] = m.date; });
        const progressHTML = stageOrder.map((st, idx) => `
            <div class="timeline-item ${idx <= currentIdx ? 'completed' : ''}">
                <div class="timeline-dot"></div>
                <div class="timeline-status">${st}</div>
                <div class="timeline-date">${dateByStage[st] || ''}</div>
            </div>
        `).join('');

        const dealViewHTML = `
            <div class="flex items-center mb-4">
                <button class="p-1 rounded hover:bg-gray-200" onclick="showInboxView()"><i class="ri-arrow-left-s-line text-lg"></i></button>
                <h2 id="deal-title-${dealId}" class="font-bold text-base ml-2 outline-none" contenteditable="true" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}" onblur="saveDealName('${dealId}', this.textContent.trim())">${data.dealName}</h2>
                <span class="ml-auto label-chip ${statusClass(currentStage)}">${currentStage}</span>
            </div>

            <div class="mb-3 deal-meta">
                <div class="deal-meta-item">
                    <span class="meta-label">Value:</span>
                    <span class="value-badge"><i class="ri-money-dollar-circle-line"></i>${data.value}</span>
                </div>
                <div class="deal-meta-item">
                    <span class="meta-label">Company:</span>
                    <span class="company-line">
                        <img src="https://placehold.co/16x16/A78BFA/FFFFFF?text=${data.companyAvatar}" class="company-avatar">
                        <span class="text-sm font-semibold">${data.company}</span>
                        <button class="link-btn" onclick="alert('Open ${data.company} details')">View</button>
                    </span>
                </div>
                <div class="deal-meta-item">
                    <span class="meta-label">Contacts:</span>
                    <span class="contacts-wrap">
                        ${data.contacts.map(c => `
                            <span class=\"contact-chip\">
                                <span class=\"avatar\">${(c.avatar||c.name||'?').toString().slice(0,1)}</span>
                                <span>${c.name}</span>
                            </span>
                        `).join('')}
                    </span>
                </div>
            </div>

            <div class="border-t pt-3 mb-4">
                <h3 class="text-xs font-semibold text-gray-500 mb-2">Progress</h3>
                <div class="timeline">${progressHTML}</div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                <h3 class="text-xs font-semibold text-gray-500 mb-2">Per Interaction Summary</h3>
                <div class="space-y-2">
                    ${(data.timeline || []).map(m => `
                        <div class=\"flex items-start gap-2\">
                            <span class=\"text-[11px] text-gray-500 mt-0.5\">${m.date}</span>
                            <div class=\"flex-1 text-xs text-gray-700 outline-none\" contenteditable=\"true\" onkeydown=\"if(event.key==='Enter'){event.preventDefault();this.blur();}\" onblur=\"saveDealNoteStage('${dealId}','${canonicalizeStatus(m.status)}', this.textContent.trim())\">${(data._notes && data._notes[canonicalizeStatus(m.status)]) || canonicalizeStatus(m.status)+' update'}</div>
                        </div>
                    `).join('')}
                    ${!(data.timeline||[]).length ? '<div class=\'text-[11px] text-gray-400\'>No interactions yet</div>' : ''}
                </div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                <div class="flex items-center mb-2">
                    <h3 class="text-xs font-semibold text-gray-500">Notes</h3>
                    <button class="ml-auto link-btn" onclick="addDealNote('${dealId}')"><i class="ri-add-line"></i> Add</button>
                </div>
                <div id="notes-list-${dealId}" class="space-y-2 text-xs text-gray-700"></div>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                <h3 class="text-xs font-semibold text-gray-500 mb-2">Summary</h3>
                <div class="text-xs text-gray-700">${data.summary}</div>
            </div>
        `;
            dhDealView.innerHTML = dealViewHTML;

            dhInboxView.classList.add('hidden');
            dhDealView.classList.remove('hidden');
            if (dhInboxView) dhInboxView.hidden = true;
            if (dhDealView) dhDealView.hidden = false;

            renderDealNotes(dealId);
        }

        function logFeedbackEntry(iconClass, title, detail) {
            const feedbackLog = document.getElementById('dh-feedback-log');
            if (!feedbackLog) return;

            const entry = document.createElement('div');
            entry.className = 'bg-white border border-indigo-100 rounded-md p-2 text-xs text-gray-600 flex items-start animate-fade-in';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            entry.innerHTML = `
                <i class="${iconClass} mr-2 mt-0.5"></i>
                <div class="w-full">
                    <div class="flex items-center"><span class="font-semibold text-gray-800">${title}</span><span class="ml-auto text-[10px] uppercase text-gray-400">${timestamp}</span></div>
                    <p>${detail}</p>
                </div>`;

            feedbackLog.prepend(entry);

            // Limit log to 5 entries for the mock UI
            while (feedbackLog.children.length > 5) {
                feedbackLog.removeChild(feedbackLog.lastElementChild);
            }
        }

        function renderDealNotes(dealId) {
            const container = document.getElementById(`notes-list-${dealId}`);
            if (!container) return;
            const notes = (dealData[dealId] && dealData[dealId].notes) || [];
            if (!notes.length) {
                container.innerHTML = '<div class="text-[11px] text-gray-400">No notes yet</div>';
                return;
            }
            container.innerHTML = notes.map(n => `
                <div class="flex items-start gap-2">
                    <span class="text-[10px] text-gray-400 mt-0.5">${new Date(n.ts).toLocaleDateString()} ${new Date(n.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    <div class="flex-1">${n.text}</div>
                </div>
            `).join('');
        }

        function addDealNote(dealId) {
            const text = prompt('Add a note');
            if (!text) return;
            if (!dealData[dealId]) return;
            if (!dealData[dealId].notes) dealData[dealId].notes = [];
            dealData[dealId].notes.unshift({ ts: Date.now(), text });
            renderDealNotes(dealId);
            logFeedbackEntry('ri-edit-2-line text-indigo-500', 'Note added', `Saved to ${dealData[dealId].dealName}`);
        }

        function quickThreadAction(event, dealId, action) {
            event.stopPropagation();
            const actionCopy = {
                mark: 'Thread promoted into CRM pipeline',
                move: 'Thread reassigned to another deal',
                remove: 'Thread removed from CRM & label cleared',
                assign: 'Owner assigned and notified',
                mute: 'Thread muted as non-CRM noise'
            };
            const iconMap = {
                mark: 'ri-sparkling-2-line text-indigo-500',
                move: 'ri-arrow-right-up-line text-indigo-500',
                remove: 'ri-close-circle-line text-rose-500',
                assign: 'ri-user-shared-line text-indigo-500',
                mute: 'ri-notification-off-line text-gray-500'
            };
            const dealLabel = dealId ? dealId.toUpperCase() : 'NO DEAL';
            const detail = `Deal ref: ${dealLabel}. Snapshot stored in Firestore and feedback stream.`;
            logFeedbackEntry(iconMap[action] || 'ri-information-line text-indigo-500', actionCopy[action] || 'Thread action recorded', detail);
        }

        function captureDealOverride(action, dealId) {
            const copy = {
                rename: 'Deal renamed by user',
                merge: 'Deal merged with another opportunity',
                split: 'Deal split into a new opportunity',
                remove: 'Deal removed from CRM'
            };
            const icons = {
                rename: 'ri-edit-2-line text-indigo-500',
                merge: 'ri-git-merge-line text-indigo-500',
                split: 'ri-git-branch-line text-indigo-500',
                remove: 'ri-delete-bin-6-line text-rose-500'
            };
            logFeedbackEntry(icons[action] || 'ri-information-line text-indigo-500', copy[action] || 'Deal override recorded', `Deal ref: ${dealId.toUpperCase()}. Changes persisted to Firestore + feedback store.`);
        }

        function saveDealNote(dealId) {
            const textarea = document.getElementById(`deal-note-${dealId}`);
            if (!textarea) return;
            const note = textarea.value.trim();
            if (!note) return;
            logFeedbackEntry('ri-sticky-note-line text-indigo-500', 'Note saved to deal', `Deal ref: ${dealId.toUpperCase()}. Note: ${note}`);
            textarea.value = '';
        }

        function toggleDropdown(menuId) {
            document.getElementById(menuId).classList.toggle('hidden');
        }

        function saveDealName(dealId, name) {
            if (!name) return;
            if (dealData[dealId]) {
                dealData[dealId].dealName = name;
                updateDhInboxLabels();
            }
        }

        function saveDealSummary(dealId, text) {
            if (dealData[dealId]) {
                dealData[dealId].summary = text || dealData[dealId].summary;
            }
        }

        function saveDealNoteStage(dealId, stage, text) {
            if (!dealData[dealId]) return;
            if (!dealData[dealId]._notes) dealData[dealId]._notes = {};
            dealData[dealId]._notes[stage] = text || '';
        }

        window.onclick = function(event) {
            if (!event.target.matches('.ri-more-2-fill')) {
                var dropdowns = document.querySelectorAll("[id^='deal-menu']");
                dropdowns.forEach(function(openDropdown) {
                    if (!openDropdown.classList.contains('hidden')) {
                        openDropdown.classList.add('hidden');
                    }
                });
            }
        }
        
        // Sidebar-only auth flow
        const dhLoginView = document.getElementById('dh-login-view');
        const dhOnboardingView = document.getElementById('dh-onboarding-view');
        const dhDashboardView = document.getElementById('dh-inbox-view');
        const dhPipelineView = document.getElementById('dh-pipeline-view');
        let dhObTimer = null;

        function showDhLogin() {
            if (dhLoginView) { dhLoginView.classList.remove('hidden'); dhLoginView.hidden = false; }
            if (dhOnboardingView) { dhOnboardingView.classList.add('hidden'); dhOnboardingView.hidden = true; }
            if (dhDashboardView) { dhDashboardView.classList.add('hidden'); dhDashboardView.hidden = true; }
            if (dhPipelineView) { dhPipelineView.classList.add('hidden'); dhPipelineView.hidden = true; }
            document.body.classList.add('hide-dh');
        }
        function showDhOnboarding() {
            if (dhLoginView) { dhLoginView.classList.add('hidden'); dhLoginView.hidden = true; }
            if (dhOnboardingView) { dhOnboardingView.classList.remove('hidden'); dhOnboardingView.hidden = false; }
            if (dhDashboardView) { dhDashboardView.classList.add('hidden'); dhDashboardView.hidden = true; }
            if (dhPipelineView) { dhPipelineView.classList.add('hidden'); dhPipelineView.hidden = true; }
            document.body.classList.add('hide-dh');
        }
        function showDhDashboard() {
            if (dhLoginView) { dhLoginView.classList.add('hidden'); dhLoginView.hidden = true; }
            if (dhOnboardingView) { dhOnboardingView.classList.add('hidden'); dhOnboardingView.hidden = true; }
            if (dhDashboardView) { dhDashboardView.classList.remove('hidden'); dhDashboardView.hidden = false; }
            if (dhPipelineView) { dhPipelineView.classList.add('hidden'); dhPipelineView.hidden = true; }
            document.body.classList.remove('hide-dh');
            updateDhInboxLabels();
        }
        function startSidebarOnboarding() {
            showDhOnboarding();
            const total = 200, steps = 100, durationMs = 10000, intervalMs = Math.floor(durationMs / steps);
            const targets = {
                fetched: total,
                // All fetched should eventually be classified
                classified: total,
                // CRM subset of classified
                sales: Math.floor(total * 0.36),
                // Only CRM emails should be extracted & enriched
                enriched: Math.floor(total * 0.36),
                opps: 22,
                contacts: 48,
                companies: 18
            };
            const els = {
                bar: document.getElementById('dh-ob-bar'),
                label: document.getElementById('dh-ob-label'),
                fetched: document.getElementById('dh-ob-fetched'),
                classified: document.getElementById('dh-ob-classified'),
                sales: document.getElementById('dh-ob-sales'),
                enriched: document.getElementById('dh-ob-enriched'),
                opps: document.getElementById('dh-ob-opps'),
                contacts: document.getElementById('dh-ob-contacts'),
                companies: document.getElementById('dh-ob-companies'),
                success: document.getElementById('dh-ob-success'),
            };
            let s=0; if (dhObTimer) clearInterval(dhObTimer);
            dhObTimer = setInterval(()=>{
                s++; const r=Math.min(1,s/steps), pct=Math.round(r*100);
                if(els.bar) els.bar.style.width=pct+'%';
                if(els.label) els.label.textContent=pct+'%';
                if(els.fetched) els.fetched.textContent=`${Math.floor(targets.fetched*r)}/${total}`;
                if(els.classified) els.classified.textContent=Math.floor(targets.classified*r);
                if(els.sales) els.sales.textContent=Math.floor(targets.sales*r);
                if(els.enriched) els.enriched.textContent=Math.floor(targets.enriched*r);
                if(els.opps) els.opps.textContent=Math.floor(targets.opps*r);
                if(els.contacts) els.contacts.textContent=Math.floor(targets.contacts*r);
                if(els.companies) els.companies.textContent=Math.floor(targets.companies*r);
                if(r>=1){ clearInterval(dhObTimer); if(els.success) els.success.classList.remove('hidden'); }
            }, intervalMs);
        }
        function initSidebarFlow(){
            const btnLogin = document.getElementById('dh-btn-google-login');
            const btnGo = document.getElementById('dh-btn-go-dashboard');
            if (btnLogin) btnLogin.onclick = ()=>{ startSidebarOnboarding(); };
            if (btnGo) btnGo.onclick = ()=>{ showDhDashboard(); };
            // Always show login on refresh per request
            showDhLogin();
        }

        function renderPipeline() {
            const container = document.getElementById('dh-pipeline-container');
            if (!container) return;
            const order = ['Lead','Prospect','Qualified','Proposal','Negotiation','Closed'];
            const groups = Object.create(null);
            order.forEach(k => groups[k] = []);
            Object.keys(dealData).forEach(id => {
                const d = dealData[id];
                const st = canonicalizeStatus(d.status);
                if (!groups[st]) groups[st] = [];
                groups[st].push({id, d});
            });
            // Add extra closed deals for demo
            if (!groups['Closed']) groups['Closed'] = [];
            const closedExtras = [
                { dealName: 'ACME Renewal', company: 'ACME Inc.', value: '$12,000', status: 'Closed' },
                { dealName: 'Globex Pilot', company: 'Globex Corp', value: '$8,500', status: 'Closed' },
                { dealName: 'Initech Upgrade', company: 'Initech', value: '$15,200', status: 'Closed' },
                { dealName: 'Soylent POC', company: 'Soylent', value: '$6,800', status: 'Closed' },
                { dealName: 'Stark Labs License', company: 'Stark Labs', value: '$22,000', status: 'Closed' },
                { dealName: 'Wayne Ent. Support', company: 'Wayne Enterprises', value: '$5,400', status: 'Closed' }
            ];
            closedExtras.forEach((d, idx) => groups['Closed'].push({ id: `closed-${idx}`, d }));
            const parts = [];
            order.forEach(st => {
                const list = groups[st] || [];
                const folded = (st === 'Closed');
                const count = list.length;
                parts.push(`
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <div class="px-3 py-2 flex items-center justify-between ${folded ? 'cursor-pointer' : ''}" ${folded ? 'data-folded="true" onclick="this.nextElementSibling.classList.toggle(\'hidden\')"' : ''}>
                            <div class="flex items-center"><span class="text-xs font-semibold text-gray-700">${st}</span>
                            <span class="ml-2 text-[11px] text-gray-500">${count}</span></div>
                            ${folded ? '<i class="ri-arrow-down-s-line text-gray-500"></i>' : ''}
                        </div>
                        <div class="${folded ? 'hidden' : ''}">
                            ${list.map(({id,d}) => `
                                <div class=\"p-2 border-t border-gray-100\">
                                    <div class=\"bg-white border border-gray-200 rounded-md shadow-sm p-3\">
                                        <div class=\"flex items-center justify-between\">
                                            <div class=\"text-sm font-semibold text-gray-900 truncate\">${d.dealName}</div>
                                            <span class=\"label-chip ${statusClass(canonicalizeStatus(d.status || st))}\">${canonicalizeStatus(d.status || st)}</span>
                                        </div>
                                        <div class=\"text-xs text-gray-500 mt-1 flex items-center justify-between\">
                                            <span class=\"truncate\">${d.company || ''}</span>
                                            <span>${d.value || ''}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${count === 0 ? '<div class="px-3 py-4 text-[11px] text-gray-400 border-t border-gray-100">No deals</div>' : ''}
                        </div>
                    </div>
                `);
            });
            container.innerHTML = parts.join('');
        }

        function showDhPipeline() {
            const pipelineView = document.getElementById('dh-pipeline-view');
            if (!pipelineView) return;
            const lv = document.getElementById('dh-login-view');
            const ov = document.getElementById('dh-onboarding-view');
            const dv = document.getElementById('dh-inbox-view');
            if (lv) { lv.classList.add('hidden'); lv.hidden = true; }
            if (ov) { ov.classList.add('hidden'); ov.hidden = true; }
            if (dv) { dv.classList.add('hidden'); dv.hidden = true; }
            pipelineView.classList.remove('hidden');
            pipelineView.hidden = false;
            renderPipeline();
        }

        function initPipelineHandlers() {
            const btn = document.getElementById('btn-view-pipeline');
            if (btn) btn.onclick = showDhPipeline;
            ['ps-deals','ps-inpipeline','ps-closed'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.onclick = showDhPipeline;
            });
            const back = document.getElementById('btn-pipeline-back');
            if (back) back.onclick = showDhDashboard;
            const home = document.getElementById('btn-dh-home');
            if (home) home.onclick = showDhDashboard;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // keep inbox UI intact
            showInboxView();
            initSidebarToggle();
            applySidebarVisibility();
            document.body.classList.add('hide-dh');
            initSidebarFlow();
            initPipelineHandlers();
        });
        window.addEventListener('resize', () => {
            updateToggleButtonState();
        });
    </script>
</body>
</html>
